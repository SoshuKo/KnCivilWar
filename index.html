<!DOCTYPE html>
<html>
<head>
    <title>プロヴィンス移動実験</title>
    <style>
        #coordinates, #turnControls, #sideMenu {
        position: absolute; /* 要素を固定 */
        }
        #mapCanvas {
            border: 1px solid black;
        }
        #dataCanvas {
            display: none;
        }
        #roadCanvas {
            display: none; /* 追加 */
        }
        #coordinates {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border: 1px solid black;
        }
        .base-icon {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: blue;
            border-radius: 50%;
            cursor: pointer;
        }
        #sideMenu {
            position: absolute;
            top: 50px;
            right: 10px;
            width: 200px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border: 1px solid black;
            display: none;
        }
        #turnControls {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border: 1px solid black;
        }
        #eventMenu {
            position: fixed;
            top: 100px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border: 1px solid black;
            display: none; /* 初期状態は非表示 */
        }
        #flagDisplay {
            position: fixed;
            top: 50px;
            left: 10px;
            width: 50px;
            height: 30px;
            display: none; /* 初期状態は非表示 */
        }
        #countrySelection button img {
            width: 20px; /* 国旗画像の幅を調整 */
            height: 10px; /* 国旗画像の高さを調整 */
            vertical-align: middle; /* 国旗画像を垂直方向に中央揃え */
        }
        .ship-production {
            display: none;
        }
        .side-menu {
            position: fixed;
            top: 100px;
            left: 10px;
            border: 1px solid black;
            padding: 10px;
            background-color: white;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            opacity: 0.8; /* 透明度を 0.8 に設定 */
        }
    </style>
</head>
<body>
    <canvas id="mapCanvas"></canvas>
    <canvas id="dataCanvas"></canvas>
    <canvas id="roadCanvas"></canvas>
    <div id="coordinates"></div>
    <div id="sideMenu">
        <h2>基地情報</h2>
        <p id="baseName"></p>
        <p id="baseFaction">陣営: 不明</p> <!-- 陣営情報を表示する要素を追加 -->
        <div id="productionButtons">
            <button data-unit-type="infantry">歩兵生産</button>
            <button data-unit-type="tank">戦車生産</button>
            <button data-unit-type="ship" class="ship-production">艦艇生産</button>
        </div>
        <p>基地の詳細情報などをここに追加できます。</p>
    </div>
    <div id="turnControls">
        <p>ターン: <span id="turnDisplay">1</span></p>
        <button id="nextTurnButton">ターンを前進</button>
    </div>
    <div id="provinceIdDisplay" style="position: fixed; top: 100px; right: 10px; background-color: rgba(255, 255, 255, 0.7); padding: 5px; border: 1px solid black;">
        プロヴィンスID: 不明
    </div>
    <div id="resources" style="position: fixed; top: 10px; right: 120px; background-color: rgba(255, 255, 255, 0.7); padding: 5px; border: 1px solid black;">
        資源: <span id="resourceDisplay">10</span>
    </div>
    <div id="productionQueueDisplay" style="position: fixed; top: 10px; right: 300px; background-color: rgba(255, 255, 255, 0.7); padding: 5px; border: 1px solid black;">
        生産中: <span id="productionQueueList">なし</span>
    </div>
    <div id="eventMenu">
        <h2>イベント</h2>
        <div id="countrySelection">
            <p>プレイする国を選択してください:</p>
            <button data-country-id="01"><img src="flag_01.png" alt="スクニューネ共和国">スクニューネ共和国</button>
            <button data-country-id="21"><img src="flag_21.png" alt="スングィールタ州">スングィールタ州</button>
            <button data-country-id="22"><img src="flag_22.png" alt="スィジュールタ州">スィジュールタ州</button>
            <button data-country-id="41"><img src="flag_41.png" alt="ニグラシオ共和国">ニグラシオ共和国</button>
            <button data-country-id="42"><img src="flag_42.png" alt="スカカルテ州">スカカルテ州</button>
        </div>
    </div>
    <img id="flagDisplay" src="" alt="選択した国の国旗">
    <div id="unitSideMenu" class="side-menu" style="display: none;">
        <input type="number" id="targetUnitIdInput" placeholder="攻撃対象ID">
        <button id="attackButton">攻撃</button>
    </div>
    <div id="commandInputContainer" style="position: fixed; bottom: 10px; left: 10px; background-color: white; padding: 5px; border: 1px solid black;">
        <input type="text" id="commandInput" placeholder="コマンドを入力">
        <button id="executeCommandButton">実行</button>
    </div>
    <script>
        let turn = 1; // ターン数を初期化
        let resources = 10; // 資源の初期値
        let cpu1Resources = 10; // CPU1の資源
        let cpu2Resources = 10; // CPU2の資源
        const cpu1ProductionQueue = []; // CPU1の生産待機キュー
        const cpu2ProductionQueue = []; // CPU2の生産待機キュー
        let isCpuBattleEnabled = true; // デフォルトはオン
        const eventMenu = document.getElementById('eventMenu');
        const flagDisplay = document.getElementById('flagDisplay');
        const units = []; // ユニットを格納する配列
        let selectedCountryId = null;
        const unitImages = {}; // ユニット画像を格納するオブジェクト
        let selectedUnit = null; // 選択中のユニットを格納する変数
        const unitSideMenu = document.getElementById('unitSideMenu'); // unitSideMenu 変数を宣言
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const dataCanvas = document.getElementById('dataCanvas');
        const dataCtx = dataCanvas.getContext('2d');
        const roadCanvas = document.getElementById('roadCanvas');
        const roadCtx = roadCanvas.getContext('2d');
        const displayImage = new Image();
        const dataImage = new Image();
        const roadImage = new Image();
        let unitPosition = { x: 646, y: 689 };
        let highlightedPixels = [];
        const coordinatesDiv = document.getElementById('coordinates');
        const sideMenu = document.getElementById('sideMenu');
        const baseNameDisplay = document.getElementById('baseName');
        const productionQueue = []; // 生産待機キュー
        let unitIdCounter = 1; // グローバルスコープで宣言
        const commandInput = document.getElementById('commandInput');
        const executeCommandButton = document.getElementById('executeCommandButton');
        const bases = [
            { name: 'ステーネ', minX: 262, maxX: 451, minY: 133, maxY: 329, provinceId: 7 },
            { name: 'ブラウジア', minX: 384, maxX: 509, minY: 303, maxY: 390, provinceId: 22 },
            { name: 'ブムァートネ', minX: 713, maxX: 875, minY: 335.3333282470703, maxY: 418.3333282470703, provinceId: 23 },
            { name: 'スミウルタ', minX: 609, maxX: 672, minY: 409, maxY: 446, provinceId: 31 },
            { name: 'ガケ', minX: 793, maxX: 934, minY: 596, maxY: 722, provinceId: 64 },
            { name: 'スツューフテ', minX: 615, maxX: 677, minY: 667, maxY: 712, provinceId: 79 },
            { name: 'スカカルテ', minX: 1094, maxX: 1166, minY: 736, maxY: 804, provinceId: 104 },
            { name: 'スプミウスタルテ', minX: 883, maxX: 933, minY: 771, maxY: 848, provinceId: 112 },
            { name: 'ルイネ', minX: 510, maxX: 597, minY: 795.3333129882812, maxY: 915.3333129882812, provinceId: 119, shipProvinceId: 118 },
            { name: 'ルルペ', minX: 668, maxX: 725, minY: 795.3333129882812, maxY: 853.3333129882812, provinceId: 120, shipProvinceId: 118 },
            { name: 'スツィーフタルテ', minX: 755, maxX: 771, minY: 986, maxY: 996, provinceId: 141 },
            { name: 'シュメケルペ', minX: 682, maxX: 747, minY: 1119.3333129882812, maxY: 1235.3333129882812, provinceId: 146, shipProvinceId: 145 }
        ];

// 画像ファイルのパスを定義
const imagePaths = {
    blue_infantry: 'blue_infantry.PNG',
    red_infantry: 'red_infantry.PNG',
    green_infantry: 'green_infantry.PNG',
    blue_tank: 'blue_tank.PNG',
    red_tank: 'red_tank.PNG',
    green_tank: 'green_tank.PNG',
    blue_ship: 'blue_ship.PNG',
    red_ship: 'red_ship.PNG',
    green_ship: 'green_ship.PNG'
};

        // プロヴィンスIDと隣接プロヴィンスの定義
        const provinceColors = {
    '1': 'rgb(32, 0, 255)',
    '2': 'rgb(32, 16, 255)',
    '3': 'rgb(32, 32, 255)',
    '4': 'rgb(32, 48, 255)',
    '5': 'rgb(32, 64, 255)',
    '6': 'rgb(32, 80, 255)',
    '7': 'rgb(32, 96, 255)',
    '8': 'rgb(32, 128, 255)',
    '9': 'rgb(32, 144, 255)',
    '10': 'rgb(32, 160, 255)',
    '11': 'rgb(32, 176, 255)',
    '12': 'rgb(32, 192, 255)',
    '13': 'rgb(32, 208, 255)',
    '14': 'rgb(32, 224, 255)',
    '15': 'rgb(32, 240, 255)',
    '16': 'rgb(48, 0, 255)',
    '17': 'rgb(48, 16, 255)',
    '18': 'rgb(48, 32, 255)',
    '19': 'rgb(48, 48, 255)',
    '20': 'rgb(48, 64, 255)',
    '21': 'rgb(48, 80, 255)',
    '22': 'rgb(48, 96, 255)',
    '23': 'rgb(48, 112, 255)',
    '24': 'rgb(48, 128, 255)',
    '25': 'rgb(48, 144, 255)',
    '26': 'rgb(48, 160, 255)',
    '27': 'rgb(48, 176, 255)',
    '28': 'rgb(48, 192, 255)',
    '29': 'rgb(48, 208, 255)',
    '30': 'rgb(48, 224, 255)',
    '31': 'rgb(48, 240, 255)',
    '32': 'rgb(64, 0, 255)',
    '33': 'rgb(64, 16, 255)',
    '34': 'rgb(64, 32, 255)',
    '35': 'rgb(64, 48, 255)',
    '36': 'rgb(64, 64, 255)',
    '37': 'rgb(64, 80, 255)',
    '38': 'rgb(64, 96, 255)',
    '39': 'rgb(64, 112, 255)',
    '40': 'rgb(64, 128, 255)',
    '41': 'rgb(0, 208, 255)',
    '42': 'rgb(64, 144, 255)',
    '43': 'rgb(64, 160, 255)',
    '44': 'rgb(64, 176, 255)',
    '45': 'rgb(64, 192, 255)',
    '46': 'rgb(255, 0, 10)',
    '47': 'rgb(64, 208, 255)',
    '48': 'rgb(64, 224, 255)',
    '49': 'rgb(64, 240, 255)',
    '50': 'rgb(80, 0, 255)',
    '51': 'rgb(0, 160, 255)',
    '52': 'rgb(80, 16, 255)',
    '53': 'rgb(80, 32, 255)',
    '54': 'rgb(0, 224, 255)',
    '55': 'rgb(80, 48, 255)',
    '56': 'rgb(0, 176, 255)',
    '57': 'rgb(80, 64, 255)',
    '58': 'rgb(0, 128, 255)',
    '59': 'rgb(80, 80, 255)',
    '60': 'rgb(0, 240, 255)',
    '61': 'rgb(0, 144, 255)',
    '62': 'rgb(16, 16, 255)',
    '63': 'rgb(80, 96, 255)',
    '64': 'rgb(80, 112, 255)',
    '65': 'rgb(80, 128, 255)',
    '66': 'rgb(0, 192, 255)',
    '67': 'rgb(255, 0, 9)',
    '68': 'rgb(255, 0, 1)',
    '69': 'rgb(80, 160, 255)',
    '70': 'rgb(80, 96, 255)',
    '71': 'rgb(80, 192, 255)',
    '72': 'rgb(80, 208, 255)',
    '73': 'rgb(0, 112, 255)',
    '74': 'rgb(255, 0, 7)',
    '75': 'rgb(255, 0, 8)',
    '76': 'rgb(0, 96, 255)',
    '77': 'rgb(16, 32, 255)',
    '78': 'rgb(255, 0, 6)',
    '79': 'rgb(255, 0, 0)',
    '80': 'rgb(80, 240, 255)',
    '81': 'rgb(80, 240, 255)',
    '82': 'rgb(96, 0, 255)',
    '83': 'rgb(255, 0, 2)',
    '84': 'rgb(16, 48, 255)',
    '85': 'rgb(96, 16, 255)',
    '86': 'rgb(96, 32, 255)',
    '87': 'rgb(16, 64, 255)',
    '88': 'rgb(96, 48, 255)',
    '89': 'rgb(0, 80, 255)',
    '90': 'rgb(96, 64, 255)',
    '91': 'rgb(255, 0, 5)',
    '92': 'rgb(96, 80, 255)',
    '93': 'rgb(255, 0, 3)',
    '94': 'rgb(96, 96, 255)',
    '95': 'rgb(96, 112, 255)',
    '96': 'rgb(255, 0, 4)',
    '97': 'rgb(0, 64, 255)',
    '98': 'rgb(96, 128, 255)',
    '99': 'rgb(96, 144, 255)',
    '100': 'rgb(16, 112, 255)',
    '101': 'rgb(96, 160, 255)',
    '102': 'rgb(16, 96, 255)',
    '103': 'rgb(96, 176, 255)',
    '104': 'rgb(96, 192, 255)',
    '105': 'rgb(80, 208, 255)',
    '106': 'rgb(96, 208, 255)',
    '107': 'rgb(112, 0, 255)',
    '109': 'rgb(0, 48, 255)',
    '110': 'rgb(0, 0, 255)',
    '111': 'rgb(112, 16, 255)',
    '112': 'rgb(112, 32, 255)',
    '113': 'rgb(112, 48, 255)',
    '114': 'rgb(16, 160, 255)',
    '115': 'rgb(112, 64, 255)',
    '116': 'rgb(16, 144, 255)',
    '117': 'rgb(0, 255, 10)',
    '118': 'rgb(0, 32, 255)',
    '119': 'rgb(16, 80, 255)',
    '120': 'rgb(0, 16, 255)',
    '121': 'rgb(16, 176, 255)',
    '122': 'rgb(16, 128, 255)',
    '123': 'rgb(112, 112, 255)',
    '124': 'rgb(112, 128, 255)',
    '125': 'rgb(112, 144, 255)',
    '127': 'rgb(112, 176, 255)',
    '128': 'rgb(112, 192, 255)',
    '129': 'rgb(112, 208, 255)',
    '130': 'rgb(112, 240, 255)',
    '131': 'rgb(128, 0, 255)',
    '132': 'rgb(128, 16, 255)',
    '133': 'rgb(128, 32, 255)',
    '134': 'rgb(0, 255, 20)',
    '135': 'rgb(128, 48, 255)',
    '136': 'rgb(128, 64, 255)',
    '137': 'rgb(128, 80, 255)',
    '138': 'rgb(128, 112, 255)',
    '139': 'rgb(128, 128, 255)',
    '140': 'rgb(128, 144, 255)',
    '141': 'rgb(128, 160, 255)',
    '142': 'rgb(128, 176, 255)',
    '143': 'rgb(128, 192, 255)',
    '144': 'rgb(0, 255, 60)',
    '145': 'rgb(0, 255, 30)',
    '146': 'rgb(128, 224, 255)',
    '147': 'rgb(0, 255, 50)',
    '148': 'rgb(0, 255, 40)',
};

        const provinceAdjacencies = {
    '1': ['2', '4', '6'],
    '2': ['1', '3', '4'],
    '3': ['2', '4', '6', '7', '8'],
    '4': ['1', '2', '3', '6'],
    '5': [],
    '6': ['1', '3', '4', '8', '9'],
    '7': ['3', '8', '11', '16'],
    '8': ['3', '6', '7', '9', '11'],
    '9': ['6', '8', '11', '13'],
    '10': ['12', '15', '17', '18'],
    '11': ['7', '8', '9', '13', '16'],
    '12': ['10', '13', '15', '16', '18', '19'],
    '13': ['9', '11', '12', '16'],
    '14': [],
    '15': ['10', '12', '18'],
    '16': ['7', '11', '12', '13', '19', '20', '22'],
    '17': ['10', '18', '19', '21', '23', '24'],
    '18': ['10', '12', '15', '17', '19'],
    '19': ['12', '16', '17', '18', '20', '24', '26', '30', '31'],
    '20': ['16', '19', '22', '29', '30'],
    '21': ['17', '23', '25'],
    '22': ['16', '20', '29'],
    '23': ['17', '21', '24', '25', '28', '32'],
    '24': ['17', '19', '23', '26', '32', '33'],
    '25': ['21', '23', '28', '32'],
    '26': ['19', '24', '30', '31', '33', '35', '38', '39'],
    '27': [],
    '28': ['25', '32'],
    '29': ['20', '22', '30', '34', '36'],
    '30': ['19', '20', '26', '29', '31', '36', '38', '41', '46'],
    '31': ['19', '26', '30'],
    '32': ['23', '24', '25', '28', '33', '37'],
    '33': ['24', '26', '32', '35', '37', '42', '44'],
    '34': ['26', '29', '36', '39', '45', '50', '52'],
    '35': ['26', '33', '39', '41', '42'],
    '36': ['29', '30', '34', '36', '45', '46', '52', '54'],
    '37': ['32', '33', '40', '44'],
    '38': ['26', '30', '39', '41'],
    '39': ['26', '35', '38', '41'],
    '40': ['37', '44', '47', '53'],
    '41': ['30', '35', '38', '39', '42', '46', '51', '56', '61', '66', '67'],
    '42': ['33', '35', '41', '44', '51'],
    '43': ['48', '55', '69', '72'],
    '44': ['33', '37', '40', '42', '51', '53', '58', '64'],
    '45': ['34', '36', '52'],
    '46': ['30', '36', '41', '54', '67', '68'],
    '47': ['40', '49', '53', '59', '63'],
    '48': ['43', '49', '63', '72'],
    '49': ['47', '63', '48'],
    '50': ['34', '52', '57', '62', '77', '85', '86'],
    '51': ['41', '42', '44', '58', '61'],
    '52': ['34', '45', '54', '50', '60', '62'],
    '53': ['40', '44', '47', '59', '64'],
    '54': ['36', '46', '52', '60', '62', '68'],
    '55': ['43', '69', '72', '104'],
    '56': ['41', '61', '66', '67'],
    '57': ['65', '50', '86'],
    '58': ['44', '51', '61', '64', '73', '76', '78'],
    '59': ['47', '53', '63', '64', '71', '80', '82', '92'],
    '60': ['52', '54', '62'],
    '61': ['41', '51', '56', '58', '67', '78'],
    '62': ['50', '52', '54', '60', '68', '77', '85'],
    '63': ['47', '48', '49', '59', '71', '72'],
    '64': ['44', '53', '58', '59', '73', '76', '80', '89', '94', '95'],
    '65': ['57', '86', '88'],
    '66': ['41', '56', '67'],
    '67': ['41', '46', '56', '61', '66', '68', '74', '75', '78'],
    '68': ['46', '54', '62', '67', '74', '77', '79', '83', '84', '87'],
    '69': ['43', '55', '72'],
    '70': [],
    '71': ['59', '63', '72', '82'],
    '72': ['43', '48', '55', '63', '69', '71', '82', '92', '101', '104', '107', '111'],
    '73': ['58', '64', '76'],
    '74': ['67', '68', '75', '78', '79'],
    '75': ['67', '74'],
    '76': ['58', '64', '73', '78', '89'],
    '77': ['62', '68', '84', '85', '100'],
    '78': ['58', '61', '67', '74', '76', '79', '89', '91', '98', '99'],
    '79': ['68', '74', '78', '83', '91', '93', '96'],
    '80': ['59', '64', '92', '94'],
    '81': [],
    '82': ['59', '71', '72', '80', '92', '94'],
    '83': ['68', '79', '87', '93'],
    '84': ['77', '68', '87', '100', '102'],
    '85': ['50', '77', '86', '100'],
    '86': ['50', '57', '65', '85', '88', '100', '114'],
    '87': ['68', '83', '84', '93', '102'],
    '88': ['65', '86'],
    '89': ['64', '76', '78', '95', '98', '99', '103', '106'],
    '90': [],
    '91': ['78', '79', '96', '97', '99'],
    '92': ['72', '80', '82', '94', '103', '107', '112'],
    '93': ['79', '83', '87', '96', '102', '110'],
    '94': ['64', '80', '92', '95', '103'],
    '95': ['64', '89', '94', '103'],
    '96': ['79', '91', '93', '97', '109', '110', '120'],
    '97': ['91', '96', '98', '99', '109', '113'],
    '98': ['89', '97', '99', '106', '113', '115'],
    '99': ['78', '91', '97', '98'],
    '100': ['68', '77', '85', '86', '87', '102', '116', '114'],
    '101': ['72', '104', '111'],
    '102': ['84', '87', '93', '100', '110', '116', '119'],
    '103': ['89', '92', '94', '95', '106', '112', '115'],
    '104': ['55', '72', '101'],
    '105': [],
    '106': ['89', '98', '103', '115'],
    '107': ['72', '92', '111', '112', '124'],
    '109': ['96', '97', '118'],
    '110': ['93', '96', '102', '119'],
    '111': ['72', '101', '107', '124'],
    '112': ['92', '103', '107', '115', '124'],
    '113': ['97', '98', '109', '115', '118', '120', '123', '125'],
    '114': ['86', '100', '116', '121'],
    '115': ['98', '103', '106', '112', '113', '123', '124'],
    '116': ['100', '102', '114', '119', '121', '122'],
    '117': ['134'],
    '118': ['109', '113', '120'],
    '119': ['102', '110', '116', '122'],
    '120': ['96', '118', '113', '125'],
    '121': ['114', '116', '122'],
    '122': ['116', '119', '122'],
    '123': ['113', '115', '124', '125', '127'],
    '124': ['107', '111', '112', '115', '123', '127', '129'],
    '125': ['113', '120', '123', '127', '131', '135', '136'],
    '127': ['123', '124', '125', '129', '131', '132'],
    '128': [],
    '129': ['124', '127', '130', '132', '133'],
    '130': ['129', '133'],
    '131': ['125', '127', '132', '135', '137', '138'],
    '132': ['127', '129', '131', '133', '137'],
    '133': ['129', '130', '132', '137', '140'],
    '134': ['117', '145'],
    '135': ['125', '131'],
    '136': ['125', '139', '140', '141', '142', '146'],
    '137': ['131', '132', '133', '140'],
    '138': ['131'],
    '139': ['136', '141'],
    '140': ['131', '133', '137', '142', '143'],
    '141': ['136', '139'],
    '142': ['136', '140', '143', '146'],
    '143': ['140', '142'],
    '144': ['147'],
    '145': ['134', '148'],
    '146': ['136', '142'],
    '147': ['144', '148'],
    '148': ['145', '147'],
};

const provinceCenters = {
    "1": { x: 486, y: 86 },
    "2": { x: 418, y: 71 },
    "3": { x: 394, y: 129 },
    "4": { x: 450, y: 105 },
    "5": { x: 406, y: 93 },
    "6": { x: 531, y: 148 },
    "7": { x: 345, y: 226 },
    "8": { x: 477, y: 166 },
    "9": { x: 507, y: 187 },
    "10": { x: 677, y: 233 },
    "11": { x: 466, y: 231 },
    "12": { x: 579, y: 239 },
    "13": { x: 535, y: 217 },
    "14": { x: 506, y: 213 },
    "15": { x: 603, y: 268 },
    "16": { x: 452, y: 294 },
    "17": { x: 742, y: 302 },
    "18": { x: 629, y: 305 },
    "19": { x: 601, y: 362 },
    "20": { x: 524, y: 364 },
    "21": { x: 880, y: 321 },
    "22": { x: 451, y: 355 },
    "23": { x: 806, y: 368 },
    "24": { x: 753, y: 404 },
    "25": { x: 909, y: 385 },
    "26": { x: 690, y: 435 },
    "27": { x: 984, y: 385 },
    "28": { x: 957, y: 445 },
    "29": { x: 494, y: 437 },
    "30": { x: 617, y: 488 },
    "31": { x: 638, y: 425 },
    "32": { x: 890, y: 466 },
    "33": { x: 794, y: 497 },
    "34": { x: 447, y: 518 },
    "35": { x: 727, y: 501 },
    "36": { x: 558, y: 523 },
    "37": { x: 875, y: 508 },
    "38": { x: 674, y: 496 },
    "39": { x: 701, y: 510 },
    "40": { x: 917, y: 543 },
    "41": { x: 695, y: 560 },
    "42": { x: 748, y: 544 },
    "43": { x: 1084, y: 595 },
    "44": { x: 825, y: 577 },
    "45": { x: 498, y: 554 },
    "46": { x: 634, y: 590 },
    "47": { x: 961, y: 568 },
    "48": { x: 1033, y: 603 },
    "49": { x: 1007, y: 579 },
    "50": { x: 434, y: 633 },
    "51": { x: 745, y: 584 },
    "52": { x: 485, y: 585 },
    "53": { x: 917, y: 602 },
    "54": { x: 565, y: 602 },
    "55": { x: 1160, y: 647 },
    "56": { x: 706, y: 601 },
    "57": { x: 353, y: 644 },
    "58": { x: 767, y: 640 },
    "59": { x: 940, y: 631 },
    "60": { x: 531, y: 612 },
    "61": { x: 735, y: 633 },
    "62": { x: 516, y: 643 },
    "63": { x: 990, y: 628 },
    "64": { x: 852, y: 655 },
    "65": { x: 244, y: 663 },
    "66": { x: 685, y: 609 },
    "67": { x: 694, y: 641 },
    "68": { x: 607, y: 653 },
    "69": { x: 1113, y: 658 },
    "70": { x: 967, y: 640 },
    "71": { x: 970, y: 662 },
    "72": { x: 1059, y: 706 },
    "73": { x: 789, y: 659 },
    "74": { x: 685, y: 672 },
    "75": { x: 680, y: 654 },
    "76": { x: 794, y: 680 },
    "77": { x: 518, y: 687 },
    "78": { x: 738, y: 700 },
    "79": { x: 645, y: 689 },
    "80": { x: 926, y: 669 },
    "81": { x: 909, y: 688 },
    "82": { x: 964, y: 706 },
    "83": { x: 594, y: 702 },
    "84": { x: 538, y: 713 },
    "85": { x: 473, y: 717 },
    "86": { x: 388, y: 721 },
    "87": { x: 563, y: 720 },
    "88": { x: 278, y: 716 },
    "89": { x: 796, y: 718 },
    "90": { x: 928, y: 694 },
    "91": { x: 691, y: 719 },
    "92": { x: 939, y: 740 },
    "93": { x: 585, y: 746 },
    "94": { x: 900, y: 727 },
    "95": { x: 858, y: 729 },
    "96": { x: 642, y: 757 },
    "97": { x: 682, y: 746 },
    "98": { x: 767, y: 766 },
    "99": { x: 733, y: 744 },
    "100": { x: 483, y: 762 },
    "101": { x: 1078, y: 762 },
    "102": { x: 534, y: 778 },
    "103": { x: 865, y: 767 },
    "104": { x: 1132, y: 773 },
    "105": { x: 1165, y: 738 },
    "106": { x: 816, y: 770 },
    "107": { x: 980, y: 744 },
    "108": { x: 964, y: 780 },
    "109": { x: 676, y: 767 },
    "110": { x: 596, y: 787 },
    "111": { x: 983, y: 805 },
    "112": { x: 909, y: 812 },
    "113": { x: 756, y: 814 },
    "114": { x: 430, y: 793 },
    "115": { x: 851, y: 816 },
    "116": { x: 483, y: 813 },
    "117": { x: 638, y: 858 },
    "118": { x: 707, y: 799 },
    "119": { x: 553, y: 860 },
    "120": { x: 696, y: 825 },
    "121": { x: 366, y: 851 },
    "122": { x: 446, y: 880 },
    "123": { x: 831, y: 851 },
    "124": { x: 918, y: 853 },
    "125": { x: 731, y: 892 },
    "126": { x: 893, y: 858 },
    "127": { x: 826, y: 880 },
    "128": { x: 890, y: 861 },
    "129": { x: 894, y: 884 },
    "130": { x: 924, y: 932 },
    "131": { x: 800, y: 931 },
    "132": { x: 853, y: 924 },
    "133": { x: 883, y: 944 },
    "134": { x: 580, y: 1006 },
    "135": { x: 750, y: 942 },
    "136": { x: 715, y: 1030 },
    "137": { x: 845, y: 972 },
    "138": { x: 785, y: 962 },
    "139": { x: 750, y: 973 },
    "140": { x: 831, y: 1010 },
    "141": { x: 762, y: 991 },
    "142": { x: 788, y: 1083 },
    "143": { x: 848, y: 1059 },
    "144": { x: 802, y: 1165 },
    "145": { x: 577, y: 1172 },
    "146": { x: 713, y: 1175 },
    "147": { x: 788, y: 1258 },
    "148": { x: 568, y: 1260 }
};

// ユニットの性能データ
const unitStats = {
    '01': { infantry: { hp: 3, atk: 3, def: 3, mov: 3, range: 1, cost: 3, time: 3 }, tank: { hp: 4, atk: 4, def: 4, mov: 2, range: 3, cost: 4, time: 4 }, ship: { hp: 3, atk: 3, def: 3, mov: 3, range: 3, cost: 3, time: 3 } },
    '03': { infantry: { hp: 3, atk: 4, def: 2, mov: 3, range: 1, cost: 4, time: 4 }, tank: { hp: 5, atk: 5, def: 4, mov: 2, range: 3, cost: 5, time: 5 }, ship: { hp: 4, atk: 4, def: 2, mov: 3, range: 4, cost: 4, time: 4 } },
    '04': { infantry: { hp: 4, atk: 2, def: 4, mov: 3, range: 1, cost: 4, time: 4 }, tank: { hp: 5, atk: 4, def: 5, mov: 2, range: 3, cost: 5, time: 5 }, ship: { hp: 5, atk: 3, def: 4, mov: 3, range: 3, cost: 4, time: 4 } },
    '21': { infantry: { hp: 4, atk: 5, def: 3, mov: 3, range: 1, cost: 5, time: 5 }, tank: { hp: 5, atk: 7, def: 5, mov: 2, range: 4, cost: 7, time: 7 }, ship: { hp: 5, atk: 5, def: 3, mov: 3, range: 4, cost: 5, time: 5 } },
    '22': { infantry: { hp: 5, atk: 3, def: 5, mov: 3, range: 1, cost: 5, time: 5 }, tank: { hp: 5, atk: 5, def: 7, mov: 2, range: 3, cost: 7, time: 7 }, ship: { hp: 4, atk: 3, def: 5, mov: 3, range: 3, cost: 5, time: 5 } },
    '23': { infantry: { hp: 2, atk: 4, def: 2, mov: 3, range: 1, cost: 2, time: 2 }, tank: { hp: 3, atk: 4, def: 3, mov: 2, range: 3, cost: 3, time: 3 }, ship: { hp: 2, atk: 4, def: 2, mov: 3, range: 3, cost: 2, time: 2 } },
    '24': { infantry: { hp: 3, atk: 2, def: 4, mov: 3, range: 1, cost: 2, time: 2 }, tank: { hp: 4, atk: 3, def: 4, mov: 2, range: 3, cost: 3, time: 3 }, ship: { hp: 3, atk: 2, def: 4, mov: 3, range: 3, cost: 2, time: 2 } },
    '25': { infantry: { hp: 2, atk: 3, def: 2, mov: 4, range: 1, cost: 2, time: 2 }, tank: { hp: 3, atk: 4, def: 3, mov: 3, range: 3, cost: 3, time: 3 }, ship: { hp: 2, atk: 3, def: 2, mov: 4, range: 3, cost: 2, time: 2 } },
    '41': { infantry: { hp: 5, atk: 5, def: 5, mov: 5, range: 2, cost: 7, time: 7 }, tank: { hp: 7, atk: 7, def: 7, mov: 4, range: 4, cost: 6, time: 6 }, ship: { hp: 5, atk: 5, def: 5, mov: 5, range: 5, cost: 7, time: 7 } },
    '42': { infantry: { hp: 5, atk: 5, def: 5, mov: 3, range: 5, cost: 7, time: 7 }, tank: { hp: 7, atk: 7, def: 7, mov: 2, range: 5, cost: 6, time: 6 }, ship: { hp: 5, atk: 5, def: 5, mov: 3, range: 5, cost: 7, time: 7 } }
};

const factions = {
    "スクニューネ陣営": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20"],
    "人民義勇軍陣営": ["21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40"],
    "少数民族陣営": ["41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59", "60"]
};
        
        displayImage.onload = function() {
            canvas.width = displayImage.width;
            canvas.height = displayImage.height;
            ctx.drawImage(displayImage, 0, 0);
            placeUnit(unitPosition.x, unitPosition.y);
            displayBases();
        };

        dataImage.onload = function() {
            dataCanvas.width = dataImage.width;
            dataCanvas.height = dataImage.height;
            dataCtx.drawImage(dataImage, 0, 0);
        }

        // グローバルスコープで定義
        let mapWidth = 0;
        let mapHeight = 0;

        roadImage.onload = function() {
            roadCanvas.width = roadImage.width;
            roadCanvas.height = roadImage.height;
            roadCtx.drawImage(roadImage, 0, 0);
            const mapWidth = roadImage.width;
            const mapHeight = roadImage.height;

            console.log(`Map dimensions: width=${mapWidth}, height=${mapHeight}`);
        }

        displayImage.src = 'スクニューネ内戦マップ1.png';
        dataImage.src = 'スクニューネ内戦マップ4.png';
        roadImage.src = 'スクニューネ内戦マップ6.png';

        // ターン1のイベント
        function turn1Event() {
            if (turn === 1) {
                eventMenu.style.display = 'block';
            } else {
                eventMenu.style.display = 'none';
            }
        }

        // 国選択ボタンのイベントリスナー
        document.getElementById('countrySelection').addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON') {
                selectedCountryId = event.target.dataset.countryId;
                flagDisplay.src = `flag_${selectedCountryId}.png`;
                flagDisplay.style.display = 'block';
                eventMenu.style.display = 'none';
            }
        });

        function updateProductionQueueDisplay() {
            const productionQueueList = document.getElementById('productionQueueList');
            if (productionQueue.length === 0) {
                productionQueueList.textContent = 'なし';
            } else {
                productionQueueList.innerHTML = productionQueue
                    .map(unit => `${unit.type} (残り${unit.remainingTime}ターン)`)
                    .join(', ');
            }
        }

        function updateProductionButtons() {
            const buttons = document.querySelectorAll('#productionButtons button');
            buttons.forEach(button => {
                const unitType = button.dataset.unitType;
                const unitCost = unitStats[selectedCountryId]?.[unitType]?.cost;

                if (unitCost !== undefined && resources >= unitCost) {
                    button.disabled = false; // 資源が足りている場合は有効化
                } else {
                    button.disabled = true; // 資源が足りない場合は無効化
                }
            });
        }

        function updateResources() {
            resources += 3; // 資源を3増加
            document.getElementById('resourceDisplay').textContent = resources; // 資源を更新
        }

        function processProductionQueue() {
    for (let i = productionQueue.length - 1; i >= 0; i--) {
        const unit = productionQueue[i];
        unit.remainingTime--; // 生産時間を減少

        if (unit.remainingTime <= 0) {
            // 生産完了、ユニットを配置
            units.push({
                id: unit.id,
                type: unit.type,
                countryId: unit.countryId,
                x: unit.x,
                y: unit.y,
                hp: unit.hp,
                def: unit.def,
                mov: unit.mov,
                currentMov: unit.currentMov
            });
            productionQueue.splice(i, 1); // キューから削除
        }
    }
    updateProductionQueueDisplay(); // 生産中ユニットの表示を更新
}

// ターン開始時にCPUの移動を実行
function nextTurn() {
    turn++;
    units.forEach(unit => {
        unit.currentMov = unit.mov; // 移動力を初期値まで回復
    });
    healUnits();
    updateResources(); // プレイヤーの資源を増加
    processProductionQueue(); // プレイヤーの生産待機キューを処理
    updateProductionButtons(); // 生産ボタンの状態を更新

    // CPUの資源を増加
    cpu1Resources += 3;
    cpu2Resources += 3;

    // CPUの生産処理
    const cpu1Faction = selectedCountryId >= 1 && selectedCountryId <= 20 ? "人民義勇軍陣営" : "スクニューネ陣営";
    const cpu2Faction = selectedCountryId >= 1 && selectedCountryId <= 40 ? "少数民族陣営" : "人民義勇軍陣営";

    const cpu1Units = units.filter(unit => factions[cpu1Faction].includes(unit.countryId));
    const cpu2Units = units.filter(unit => factions[cpu2Faction].includes(unit.countryId));

    cpu1Resources = processCpuProduction(cpu1Resources, cpu1ProductionQueue, cpu1Units, cpu1Faction);
    cpu2Resources = processCpuProduction(cpu2Resources, cpu2ProductionQueue, cpu2Units, cpu2Faction);

    // CPUの生産待機キューを処理
    processCpuProductionQueue(cpu1ProductionQueue, cpu1Units);
    processCpuProductionQueue(cpu2ProductionQueue, cpu2Units);

    if (isCpuBattleEnabled) cpuMove(); // CPUの移動を実行
    console.log(`ターン ${turn} が開始しました。`);
    document.getElementById('turnDisplay').textContent = turn;
    turn1Event(); // ターンが変わるたびにイベントチェック
}

        turn1Event();

        // 「ターンを前進」ボタンのイベントリスナー
        document.getElementById('nextTurnButton').addEventListener('click', nextTurn);

        function getProvinceColor(x, y) {
            const pixelData = dataCtx.getImageData(x, y, 1, 1).data;
            return `rgb(${pixelData[0]}, ${pixelData[1]}, ${pixelData[2]})`;
        }

        function getRoadColor(x, y) {
    // 座標が有効かどうかを確認
    if (!Number.isFinite(x) || !Number.isFinite(y)) {
        console.error(`Invalid coordinates passed to getRoadColor: x=${x}, y=${y}`);
        return null; // 無効な座標の場合は null を返す
    }

    const pixelData = roadCtx.getImageData(x, y, 1, 1).data;
    return `rgb(${pixelData[0]}, ${pixelData[1]}, ${pixelData[2]})`;
}

function getRoadId(x, y) {
    if (!Number.isFinite(x) || !Number.isFinite(y)) {
        console.error(`Invalid coordinates passed to getRoadId: x=${x}, y=${y}`);
        return null;
    }

    const color = getRoadColor(x, y);
    if (!color) {
        console.error(`Failed to get road color for coordinates: x=${x}, y=${y}`);
        return null;
    }

    for (const id in provinceColors) {
        if (provinceColors[id] === color) {
            return id;
        }
    }
    return null;
}

        // 実行ボタンのクリックイベントリスナー
        executeCommandButton.addEventListener('click', () => {
            const command = commandInput.value;
            handleCommandInput(command);
            commandInput.value = ''; // 入力欄をクリア
        });

        // コマンド入力処理関数
        function handleCommandInput(command) {
            const parts = command.split(' ');
            console.log(parts); // デバッグ用

            if (parts[0] === 'placeUnit') {
                if (parts.length !== 5) {
                    alert('コマンドの形式が正しくありません。例: placeUnit <国ID> <ユニットタイプ> <X座標> <Y座標>');
                    return;
                }

                const countryId = parts[1];
                const unitType = parts[2];
                const x = parseInt(parts[3]);
                const y = parseInt(parts[4]);

                if (isNaN(x) || isNaN(y)) {
                    alert('座標は数値で入力してください。');
                    return;
                }

                placeUnit(countryId, unitType, x, y);
                    } else if (parts[0] === 'cpuBattle') {
                        if (parts[1] === 'on') {
                            isCpuBattleEnabled = true;
                            alert('CPU対戦機能をオンにしました。');
                        } else if (parts[1] === 'off') {
                            isCpuBattleEnabled = false;
                            alert('CPU対戦機能をオフにしました。');
                        } else {
                            alert('コマンドの形式が正しくありません。例: cpuBattle on または cpuBattle off');
                        }
                    } else {
                        alert('不明なコマンドです。');
                    }
                }

// ユニット配置関数
function placeUnit(countryId, unitType, x, y) {
    if (!Number.isFinite(x) || !Number.isFinite(y)) {
        console.error(`Invalid coordinates for placing unit: x=${x}, y=${y}`);
        return;
    }

    if (!unitStats[countryId]) {
        console.error(`Unit stats not found for country ID: ${countryId}`);
        return;
    }

    const unit = {
        id: unitIdCounter++,
        type: unitType,
        countryId: countryId,
        x: x,
        y: y,
        hp: unitStats[countryId][unitType].hp,
        def: unitStats[countryId][unitType].def,
        mov: unitStats[countryId][unitType].mov, // 初期移動力
        currentMov: unitStats[countryId][unitType].mov // 現在の移動力
    };
    units.push(unit);
    drawUnits();
}

        function getProvinceCenter(x, y) {
            const provincePixels = [];
            const visited = new Set();
            const queue = [{ x, y }];
            const startColor = getProvinceColor(x, y);

            let maxIterations = 10000; // 最大探索回数を設定
            let iterations = 0;

            while (queue.length > 0) {
                const { x: cx, y: cy } = queue.shift();
                const key = `${cx},${cy}`;

                iterations++;
                if (iterations > maxIterations) {
                    console.error("プロヴィンス探索がタイムアウトしました。");
                    return { x: x, y: y }; // 探索開始位置を返す
                }

                if (visited.has(key)) {
                    continue;
                }
                visited.add(key);

                if (getProvinceColor(cx, cy) === startColor) {
                    provincePixels.push({ x: cx, y: cy });
                    queue.push({ x: cx + 1, y: cy }, { x: cx - 1, y: cy }, { x: cx, y: cy + 1 }, { x: cx, y: cy - 1 });
                }
            }

            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            provincePixels.forEach(({ x: px, y: py }) => {
                minX = Math.min(minX, px);
                maxX = Math.max(maxX, px);
                minY = Math.min(minY, py);
                maxY = Math.max(maxY, py);
            });

            const center = { x: Math.floor((minX + maxX) / 2), y: Math.floor((minY + maxY) / 2) };
            console.log(`プロヴィンス範囲: minX: ${minX}, maxX: ${maxX}, minY: ${minY}, maxY: ${maxY}`); // コンソールに範囲を出力
            return center;
        }

        function isOutsideMap(x, y) {
            return getProvinceColor(x, y) === 'rgb(255, 255, 0)'; // #FFFF00 の場合
        }

        function isBlack(x, y) {
            return getProvinceColor(x, y) === 'rgb(0, 0, 0)'; // #000000 の場合
        }

        function highlightProvince(x, y) {
            clearHighlight(); // 既存のハイライトをクリア

            if (isBlack(x, y) || isOutsideMap(x, y)) {
                return; // 黒または#FFFF00の場合はハイライトしない
            }

            const provincePixels = [];
            const visited = new Set();
            const queue = [{ x, y }];
            const startColor = getProvinceColor(x, y);

            while (queue.length > 0) {
                const { x: cx, y: cy } = queue.shift();
                const key = `${cx},${cy}`;

                if (visited.has(key)) {
                    continue;
                }
                visited.add(key);

                if (getProvinceColor(cx, cy) === startColor) {
                    provincePixels.push({ x: cx, y: cy });
                    queue.push({ x: cx + 1, y: cy }, { x: cx - 1, y: cy }, { x: cx, y: cy + 1 }, { x: cx, y: cy - 1 });
                }
            }

            highlightedPixels = provincePixels; // ハイライトされたピクセルを格納

            provincePixels.forEach(({ x: px, y: py }) => {
                ctx.fillStyle = 'rgba(0, 255, 0, 0.3)'; // ハイライトの色（透明な緑）
                ctx.fillRect(px, py, 1, 1);
            });
        }

        function clearHighlight() {
    highlightedPixels.forEach(({ x: px, y: py }) => {
        let isUnitPixel = false;
        units.forEach(unit => {
            if (px >= unit.x - 10 && px <= unit.x + 10 && py >= unit.y - 10 && py <= unit.y + 10) {
                isUnitPixel = true;
            }
        });
        if (!isUnitPixel) {
            ctx.drawImage(displayImage, px, py, 1, 1, px, py, 1, 1); // ユニットのピクセルでなければ元の画像に戻す
        }
        });
        highlightedPixels = []; // 配列をクリア
        drawUnits(); // ユニットを再描画
}

        // ユニット生産ボタンのイベントリスナー
        document.getElementById('productionButtons').addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON') {
                const unitType = event.target.dataset.unitType;
                produceUnit(unitType);
            }
        });

// 基地の座標を格納するオブジェクト
const baseCoordinates = {
    'ステーネ': { x: 356.5, y: 231 },
    'ブラウジア': { x: 446.5, y: 346.5 },
    'スミウルタ': { x: 640.5, y: 427.5 },
    'ブムァートネ': { x: 815, y: 360 },
    'ガケ': { x: 863.5, y: 659 },
    'スツューフテ': { x: 646, y: 689.5 },
    'スカカルテ': { x: 1130, y: 770 },
    'スプミウスタルテ': { x: 908, y: 809.5 },
    'ルルペ': { x: 696.5, y: 824.3333129882812 },
    'ルイネ': { x: 553.5, y: 855.3333129882812 },
    'スツィーフタルテ': { x: 763, y: 991 },
    'シュメケルペ': { x: 714.5, y: 1177.3333129882812 },
    'ルイネ(艦)': { x: 610, y: 850 },
    'ルルペ(艦)': { x: 670, y: 870 },
    'シュメケルペ(艦)': { x: 780, y: 1170 }
};

// ユニット生産関数
function produceUnit(unitType) {
    if (!selectedCountryId) {
        alert('国を選択してください。');
        return;
    }

    const base = bases.find(b => b.name === baseNameDisplay.textContent);
    if (!base) return;

    // 基地の存在するプロヴィンスに同じ陣営のユニットがいるか確認
    const provinceId = base.provinceId;
    const unitsInProvince = units.filter(unit => getRoadId(unit.x, unit.y) === String(provinceId));
    const isSameFactionPresent = unitsInProvince.some(unit => {
    // プレイヤーが選択した国が属する陣営を取得
    const playerFaction = Object.keys(factions).find(faction =>
        factions[faction].includes(selectedCountryId)
    );

    // プロヴィンス内のユニットがプレイヤーの陣営に属しているか確認
    return playerFaction && factions[playerFaction].includes(unit.countryId);
});

    if (!isSameFactionPresent) {
        alert('この基地のプロヴィンスに自分の陣営のユニットが存在しないため、生産できません。');
        return;
    }

    const unitStatsForCountry = unitStats[selectedCountryId];
    if (!unitStatsForCountry || !unitStatsForCountry[unitType]) {
        console.error(`Unit stats not found for country ID: ${selectedCountryId}, unit type: ${unitType}`);
        return;
    }

    const unitCost = unitStatsForCountry[unitType].cost;
    const unitTime = unitStatsForCountry[unitType].time;

    // 資源が足りない場合
    if (resources < unitCost) {
        alert('資源が不足しています。');
        return;
    }

    let baseCoord;
    if (unitType === 'ship') {
        baseCoord = baseCoordinates[base.name + '(艦)'];
    } else {
        baseCoord = baseCoordinates[base.name];
    }

    if (!baseCoord) {
        console.error(`Base coordinates for ${base.name} not found.`);
        return;
    }

    const x = baseCoord.x;
    const y = baseCoord.y;

    resources -= unitCost;
    document.getElementById('resourceDisplay').textContent = resources;

    productionQueue.push({
        id: unitIdCounter++,
        type: unitType,
        countryId: selectedCountryId,
        x: x,
        y: y,
        hp: unitStats[selectedCountryId][unitType].hp,
        def: unitStats[selectedCountryId][unitType].def,
        mov: unitStats[selectedCountryId][unitType].mov, // 初期移動力
        currentMov: unitStats[selectedCountryId][unitType].mov, // 現在の移動力
        remainingTime: unitTime // 残り生産時間
    });
    updateProductionQueueDisplay(); // 生産中ユニットの表示を更新
    updateProductionButtons(); // 生産ボタンの状態を更新
}
        
        // ユニット画像を事前に読み込む関数
        function preloadUnitImages() {
            ['infantry', 'tank', 'ship'].forEach(type => {
                ['blue', 'red', 'green'].forEach(color => {
                    const img = new Image();
                    img.src = `${color}_${type}.png`;
                    unitImages[`${color}_${type}`] = img;
                });
            });
        }

        // ユニット描画関数
        function drawUnits() {
    ctx.drawImage(displayImage, 0, 0); // 地図を再描画
    units.forEach(unit => {
        let color = '';
        if (unit.countryId >= 1 && unit.countryId <= 20) {
            color = 'blue';
        } else if (unit.countryId >= 21 && unit.countryId <= 40) {
            color = 'red';
        } else if (unit.countryId >= 41 && unit.countryId <= 60) {
            color = 'green';
        }
        const img = unitImages[`${color}_${unit.type}`];
        if (img) {
            if (!Number.isFinite(unit.x) || !Number.isFinite(unit.y)) {
                console.error(`Invalid unit coordinates: ${JSON.stringify(unit)}`);
                return;
            }
            ctx.drawImage(img, unit.x - 10, unit.y - 10, 20, 20); // ユニットを描画
        } else {
            console.error(`Unit image not found for ${color}_${unit.type}`);
        }
    });
}

        function displayBases() {
            let currentBaseName = null; // 現在表示されている基地の名前を追跡

            bases.forEach(base => {
                const centerX = (base.minX + base.maxX) / 2;
                const centerY = (base.minY + base.maxY) / 2;
                const baseIcon = document.createElement('div');
                baseIcon.className = 'base-icon';
                baseIcon.style.left = centerX - 10 + 'px';
                baseIcon.style.top = centerY - 10 + 'px';
                document.body.appendChild(baseIcon);

                baseIcon.addEventListener('click', () => {
                    console.log(`Base: ${base.name}, Coordinates: (${centerX}, ${centerY})`); // コンソールログに座標を表示

                    if (currentBaseName === base.name) {
                        // 同じ基地がクリックされた場合、サイドメニューを閉じる
                        sideMenu.style.display = 'none';
                        currentBaseName = null;
                    } else {
                        // 異なる基地がクリックされた場合、または初めてクリックされた場合
                        baseNameDisplay.textContent = base.name;
                        sideMenu.style.display = 'block';
                        currentBaseName = base.name;

                                // 基地の陣営を判定してコンソールに出力
                        const faction = getBaseFaction(base);
                        console.log(`プロヴィンスの陣営: ${faction || 'なし'}`);

                                // 陣営情報をサイドメニューに表示
                        const baseFactionDisplay = document.getElementById('baseFaction');
                        baseFactionDisplay.textContent = `陣営: ${faction || 'なし'}`;
                    }

                    // 艦艇生産ボタンの表示/非表示を制御
                    if (base.shipProvinceId) {
                        document.querySelector(`#sideMenu button[data-unit-type="ship"]`).style.display = 'inline-block';
                    } else {
                        document.querySelector(`#sideMenu button[data-unit-type="ship"]`).style.display = 'none';
                    }
                });
            });
        }

// ユニットのステータスを表示する関数
function displayUnitStats(unit) {
    const countryId = unit.countryId;
    if (!unitStats[countryId]) {
        console.error(`Unit stats not found for country ID: ${countryId}`);
        unitSideMenu.style.display = 'none';
        return;
    }
    const maxStats = unitStats[countryId][unit.type];
    const stats = unitStats[countryId][unit.type];
    const countryName = getCountryName(unit.countryId);

    // ユニットタイプを日本語に変換
    let unitTypeJapanese = '';
    switch (unit.type) {
        case 'infantry':
            unitTypeJapanese = '歩兵';
            break;
        case 'tank':
            unitTypeJapanese = '戦車';
            break;
        case 'ship':
            unitTypeJapanese = '艦艇';
            break;
        default:
            unitTypeJapanese = unit.type;
    }

    unitSideMenu.innerHTML = `
        <h2>${countryName} ${unitTypeJapanese} (ID: ${unit.id})</h2>
        <p>体力: <progress value="${unit.hp}" max="${maxStats.hp}"></progress> (${unit.hp}/${maxStats.hp})</p>
        <p>防御力: <progress value="${unit.def}" max="${maxStats.def}"></progress> (${unit.def}/${maxStats.def})</p>
        <p>移動力: <progress value="${unit.currentMov}" max="${maxStats.mov}"></progress> (${unit.currentMov}/${maxStats.mov})</p>
        <p>攻撃力: ${stats.atk}</p>
        <p>射程: ${stats.range}</p>
        <p>生産コスト: ${stats.cost}</p>
        <p>生産時間: ${stats.time}</p>
        <input type="number" id="targetUnitIdInput" placeholder="攻撃対象ID">
        <button id="attackButton">攻撃</button>
    `;
    unitSideMenu.style.display = 'block';

    const attackButton = document.getElementById('attackButton');
    if (!factions["スクニューネ陣営"].includes(unit.countryId)) {
        attackButton.disabled = true; // 自分の陣営以外のユニットの攻撃ボタンを無効化
    } else {
        attackButton.disabled = false; // 自分の陣営のユニットは有効化
        attackButton.addEventListener('click', () => {
            const targetUnitId = parseInt(document.getElementById('targetUnitIdInput').value);
            attackUnit(unit.id, targetUnitId);
        });
    }
}

// 座標からカラーコードを取得する関数
function getColorCodeFromCoordinates(x, y) {
    // 座標を整数値に丸める
    const roundedX = Math.round(x);
    const roundedY = Math.round(y);

    // 座標が roadImage の範囲内にあるか確認
    if (roundedX < 0 || roundedX >= roadImage.width || roundedY < 0 || roundedY >= roadImage.height) {
        console.error(`Error: Coordinates (${x}, ${y}) are out of range.`);
        return null;
    }

    const canvas = document.createElement('canvas');
    canvas.width = roadImage.width;
    canvas.height = roadImage.height;
    const context = canvas.getContext('2d');
    context.drawImage(roadImage, 0, 0);
    const imageData = context.getImageData(roundedX, roundedY, 1, 1);
    const data = imageData.data;
    return `rgb(${data[0]}, ${data[1]}, ${data[2]})`;
}

// カラーコードからプロヴィンス ID を取得する関数
function getProvinceIdFromColorCode(colorCode) {
    for (const provinceId in provinceColors) {
        if (provinceColors[provinceId] === colorCode) {
            return parseInt(provinceId);
        }
    }
    return null;
}

function areProvincesAdjacent(provinceId1, provinceId2) {
    console.log(`provinceId1: ${provinceId1}, type: ${typeof provinceId1}`);
    console.log(`provinceId2: ${provinceId2}, type: ${typeof provinceId2}`);
    console.log(`provinceAdjacencies[provinceId1]: ${provinceAdjacencies[provinceId1]}`);
    console.log(`provinceAdjacencies[provinceId2]: ${provinceAdjacencies[provinceId2]}`);

    if (provinceId1 === provinceId2) {
        return true; // 同じプロヴィンスの場合は隣接している
    }

    if (!provinceAdjacencies[provinceId1] || !provinceAdjacencies[provinceId2]) {
        return false; // どちらかのプロヴィンスが隣接関係を持たない場合は隣接していない
    }

    // indexOf メソッドを使用して隣接関係をチェック
    const adjacent1 = provinceAdjacencies[provinceId1].indexOf(String(provinceId2)) !== -1;
    const adjacent2 = provinceAdjacencies[provinceId2].indexOf(String(provinceId1)) !== -1;

    console.log(`adjacent1: ${adjacent1}, adjacent2: ${adjacent2}`);

    return adjacent1 && adjacent2;
}

// ユニットの攻撃関数
function attackUnit(attackerId, targetId) {
    const attacker = units.find(unit => unit.id === attackerId);
    const target = units.find(unit => unit.id === targetId);

    if (!attacker || !target) {
        alert('攻撃対象が見つかりません。');
        return;
    }

    if (attacker.currentMov <= 0) {
        alert('このユニットは移動力が不足しているため攻撃できません。');
        return;
    }

    // target オブジェクトに mov プロパティが存在するか確認
    if (target.mov === undefined) {
        // ユニットオブジェクトから mov プロパティを取得し、target オブジェクトに追加
        const targetUnit = unitStats[target.countryId][target.type];
        if (targetUnit && targetUnit.mov !== undefined) {
            target.mov = targetUnit.mov;
        } else {
            console.error('Error: target.mov is undefined.');
            return; // 攻撃を中断
        }
    }

    // attacker オブジェクトに range プロパティが存在するか確認
    if (attacker.range === undefined) {
        // ユニットオブジェクトから range プロパティを取得し、attacker オブジェクトに追加
        const attackerUnit = unitStats[attacker.countryId][attacker.type];
        if (attackerUnit && attackerUnit.range !== undefined) {
            attacker.range = attackerUnit.range;
        } else {
            console.error('Error: attacker.range is undefined.');
            return; // 攻撃を中断
        }
    }

    // 回避確率を計算
    const evasionChance = target.mov * 5 - attacker.range * 5;
    console.log(`evasionChance: ${evasionChance}`); // デバッグ用

    // 回避の抽選
    const randomValue = Math.random() * 100;
    console.log(`randomValue: ${randomValue}`); // デバッグ用

    if (randomValue < evasionChance) {
        alert('攻撃は回避されました。');
        console.log('攻撃は回避されました。'); // デバッグ用
        attacker.currentMov--; // 回避されても移動力を1消費
        return; // 攻撃を中断
    }

    // ユニットの存在するプロヴィンス ID を取得
    const attackerColorCode = getColorCodeFromCoordinates(attacker.x, attacker.y);
    const targetColorCode = getColorCodeFromCoordinates(target.x, target.y);

    if (!attackerColorCode || !targetColorCode) {
        alert('ユニットのプロヴィンス ID を取得できませんでした。');
        return;
    }

    const attackerProvinceId = getProvinceIdFromColorCode(attackerColorCode);
    const targetProvinceId = getProvinceIdFromColorCode(targetColorCode);

    // プロヴィンス ID が null の場合、攻撃を中断
    if (attackerProvinceId === null || targetProvinceId === null) {
        alert('ユニットのプロヴィンス ID を取得できませんでした。');
        return;
    }

    // 隣接または同じプロヴィンスにいるかチェック
    if (!areProvincesAdjacent(attackerProvinceId, targetProvinceId)) {
        alert('攻撃対象が隣接または同じプロヴィンスにいません。');
        return;
    }

    // 攻撃処理
    const attackerStats = unitStats[attacker.countryId][attacker.type];
    const damage = attackerStats.atk;

    if (target.def > 0) {
        target.def -= damage;
        if (target.def < 0) {
            target.hp += target.def;
            target.def = 0;
        }
    } else {
        target.hp -= damage;
    }

    if (target.hp <= 0) {
        units.splice(units.indexOf(target), 1);
    }

    attacker.currentMov--; // 攻撃で移動力を1消費
    drawUnits();
    if (selectedUnit) {
        displayUnitStats(selectedUnit);
    }
}

// ユニットの自然治癒関数
function healUnits() {
    units.forEach(unit => {
        const maxStats = unitStats[unit.countryId][unit.type];
        if (unit.hp < maxStats.hp) {
            unit.hp++;
        }
    });
    drawUnits();
    if (selectedUnit) {
        displayUnitStats(selectedUnit);
    }
}

// 毎ターン実行する関数
function gameLoop() {
    setTimeout(gameLoop, 5000);
}

// ゲームループを開始
gameLoop();

// 国名を取得する関数
function getCountryName(countryId) {
    // 国IDと国名の対応関係を定義
    const countryNames = {
        '01': 'スクニューネ軍', '03': 'シュトルスカ軍', '04': 'カラベイ軍',
        '21': 'スングィールタ軍', '22': 'スィジュールタ軍', '23': 'ヴァラリア軍', '24': 'ドゥルグァタン軍', '25': 'シレナル派ニグラシオ軍',
        '41': 'ユスィネ派ニグラシオ軍', '42': 'スカカルテ軍'
    };
    return countryNames[countryId];
    }

function isEnemyInProvince(provinceId, currentUnit) {
    // 指定されたプロヴィンスにいるユニットを検索
    const enemyUnit = units.find(unit => {
        const unitProvinceId = getRoadId(unit.x, unit.y);
        if (unitProvinceId === provinceId) {
            // 敵ユニットかどうかを判定
            const isEnemy =
                (currentUnit.countryId >= 1 && currentUnit.countryId <= 20 && unit.countryId >= 21 && unit.countryId <= 60) ||
                (currentUnit.countryId >= 21 && currentUnit.countryId <= 40 && (unit.countryId <= 20 || unit.countryId >= 41)) ||
                (currentUnit.countryId >= 41 && currentUnit.countryId <= 60 && unit.countryId <= 40);
            return isEnemy;
        }
        return false;
    });

    return !!enemyUnit; // 敵ユニットが存在する場合はtrueを返す
}

// 基地の陣営を判定する関数
function getBaseFaction(base) {
    const provinceId = base.provinceId;
    const unitsInProvince = units.filter(unit => getRoadId(unit.x, unit.y) === String(provinceId));

    if (unitsInProvince.length === 0) {
        return null; // ユニットがいない場合は陣営なし
    }

    const unitCountryIds = unitsInProvince.map(unit => unit.countryId);

    for (const [factionName, countryIds] of Object.entries(factions)) {
        if (unitCountryIds.some(countryId => countryIds.includes(countryId))) {
            return factionName; // 該当する陣営を返す
        }
    }

    return null; // 該当する陣営がない場合
}

        function updateFixedElements() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft; // 横スクロール量を取得

            document.getElementById('coordinates').style.top = 10 + scrollTop + 'px';
            document.getElementById('coordinates').style.left = 10 + scrollLeft + 'px'; // 横スクロールに合わせて更新

            document.getElementById('turnControls').style.top = 10 + scrollTop + 'px';
            document.getElementById('turnControls').style.right = 10 - scrollLeft + 'px'; // 横スクロールに合わせて更新

            document.getElementById('sideMenu').style.top = 50 + scrollTop + 'px';
            document.getElementById('sideMenu').style.right = 10 - scrollLeft + 'px'; // 横スクロールに合わせて更新
        }

        window.addEventListener('scroll', updateFixedElements);

        // 初期位置を設定
        updateFixedElements();

// CPUの移動ロジック
function cpuMove() {
    const cpuFactions = Object.keys(factions).filter(faction => !factions[faction].includes(selectedCountryId));

        // CPUの攻撃処理
        cpuFactions.forEach(faction => {
        const factionUnits = units.filter(unit => factions[faction].includes(unit.countryId));

        factionUnits.forEach(unit => {
            if (unit.currentMov <= 0) return; // 移動力がない場合はスキップ

            // 隣接または同じプロヴィンスにいる敵ユニットを探す
            const currentProvinceId = getRoadId(unit.x, unit.y);
            const adjacentProvinces = provinceAdjacencies[currentProvinceId] || [];
            const potentialTargets = units.filter(target => {
                const targetProvinceId = getRoadId(target.x, target.y);
                return (
                    targetProvinceId &&
                    (targetProvinceId === currentProvinceId || adjacentProvinces.includes(targetProvinceId)) &&
                    factions[faction].every(countryId => countryId !== target.countryId) // 敵ユニットのみ
                );
            });

            if (potentialTargets.length > 0) {
                // 最初の敵ユニットを攻撃
                const target = potentialTargets[0];
                attackUnit(unit.id, target.id);
            }
        });
    });

    cpuFactions.forEach(faction => {
        const factionUnits = units.filter(unit => factions[faction].includes(unit.countryId));

        factionUnits.forEach(unit => {
            if (unit.currentMov <= 0) return; // 移動力がない場合はスキップ

            // 1: 基地のプロヴィンスに1ユニットを残す
            const baseInProvince = bases.find(base => getRoadId(unit.x, unit.y) === String(base.provinceId));
            if (baseInProvince) {
                const unitsInBaseProvince = factionUnits.filter(u => getRoadId(u.x, u.y) === String(baseInProvince.provinceId));
                if (unitsInBaseProvince.length === 1) return; // 1ユニットが基地に残る
            }

            // 2: 近くの陣営なし基地を目指す
            const neutralBase = findClosestBase(unit, base => !getBaseFaction(base));
            if (neutralBase) {
                moveUnitTowards(unit, neutralBase);
                return;
            }

            // 4: 近くの敵ユニットを目指す
            const enemyUnit = findClosestEnemyUnit(unit, faction);
            if (enemyUnit) {
                moveUnitTowards(unit, enemyUnit);
                return;
            }
        });
    });

    drawUnits(); // ユニットを再描画
}

// 指定条件に合う最も近い基地を探す
function findClosestBase(unit, condition) {
    let closestBase = null;
    let minDistance = Infinity;

    bases.forEach(base => {
        if (!condition(base)) return;

        const baseCoord = baseCoordinates[base.name];
        if (!baseCoord || !Number.isFinite(baseCoord.x) || !Number.isFinite(baseCoord.y)) {
            console.error(`Invalid base coordinates: ${JSON.stringify(baseCoord)}`);
            return;
        }

        const distance = calculateDistance(unit.x, unit.y, baseCoord.x, baseCoord.y);
        if (distance < minDistance) {
            minDistance = distance;
            closestBase = { ...base, x: baseCoord.x, y: baseCoord.y }; // 基地オブジェクトに座標を追加
        }
    });

    return closestBase;
}

// 指定条件に合う最も近い敵ユニットを探す
function findClosestEnemyUnit(unit, faction) {
    let closestEnemy = null;
    let minDistance = Infinity;

    units.forEach(enemy => {
        if (factions[faction].includes(enemy.countryId)) return; // 同じ陣営はスキップ

        const distance = calculateDistance(unit.x, unit.y, enemy.x, enemy.y);
        if (distance < minDistance) {
            minDistance = distance;
            closestEnemy = enemy;
        }
    });

    return closestEnemy;
}

function findPath(startProvinceId, targetProvinceId) {
    if (startProvinceId === targetProvinceId) {
        return [startProvinceId]; // 同じプロヴィンスの場合、経路は1つだけ
    }

    const queue = [[startProvinceId]]; // 探索キュー（経路を格納）
    const visited = new Set(); // 訪問済みプロヴィンスを記録

    while (queue.length > 0) {
        const path = queue.shift(); // キューから経路を取得
        const currentProvinceId = path[path.length - 1]; // 現在のプロヴィンスID

        if (visited.has(currentProvinceId)) {
            continue; // 既に訪問済みの場合はスキップ
        }

        visited.add(currentProvinceId); // 現在のプロヴィンスを訪問済みに追加

        const neighbors = provinceAdjacencies[currentProvinceId] || []; // 隣接プロヴィンスを取得
        for (const neighbor of neighbors) {
            if (visited.has(neighbor)) {
                continue; // 隣接プロヴィンスが訪問済みの場合はスキップ
            }

            const newPath = [...path, neighbor]; // 新しい経路を作成
            if (neighbor === targetProvinceId) {
                return newPath; // 目的地に到達した場合、経路を返す
            }

            queue.push(newPath); // 新しい経路をキューに追加
        }
    }

    return null; // 経路が見つからない場合
}

function moveUnitTowards(unit, target) {
    if (!unit || !target || !Number.isFinite(unit.x) || !Number.isFinite(unit.y) || !Number.isFinite(target.x) || !Number.isFinite(target.y)) {
        console.error(`Invalid unit or target coordinates: unit=${JSON.stringify(unit)}, target=${JSON.stringify(target)}`);
        return;
    }

    const targetProvinceId = getRoadId(target.x, target.y);
    const currentProvinceId = getRoadId(unit.x, unit.y);

    if (!targetProvinceId || !currentProvinceId) {
        console.error(`Invalid province IDs: targetProvinceId=${targetProvinceId}, currentProvinceId=${currentProvinceId}`);
        return;
    }

    const path = findPath(currentProvinceId, targetProvinceId);
    if (!path) {
        console.error(`No path found from province ${currentProvinceId} to ${targetProvinceId}`);
        return;
    }

    console.log(`Unit ${unit.id} (Country: ${unit.countryId}) is moving.`);
    console.log(`Current Province ID: ${currentProvinceId}`);
    console.log(`Target Province ID: ${targetProvinceId}`);
    console.log(`Path: ${path.join(' -> ')}`);
    console.log(`Target Coordinates: x=${target.x}, y=${target.y}`);

    for (const provinceId of path) {
        if (unit.currentMov <= 0) {
            console.log(`Unit ${unit.id} stopped at province ${provinceId} due to lack of movement points.`);
            break;
        }
        if (isEnemyInProvince(provinceId, unit)) {
            console.log(`Unit ${unit.id} stopped at province ${provinceId} due to enemy presence.`);
            break;
        }

        const provinceCenter = getProvinceCenterFromId(provinceId);
        if (!provinceCenter || !Number.isFinite(provinceCenter.x) || !Number.isFinite(provinceCenter.y)) {
            console.error(`Invalid province center: ${JSON.stringify(provinceCenter)}`);
            break;
        }

        unit.x = provinceCenter.x;
        unit.y = provinceCenter.y;
        unit.currentMov--;

        if (unit.currentMov <= 0) {
            console.log(`Unit ${unit.id} stopped at province ${provinceId} due to lack of movement points.`);
            break;
        }
    }

    drawUnits();
}

function getProvinceCenterFromId(provinceId) {
    const center = provinceCenters[String(provinceId)];
    if (!center) {
        console.error(`Province center not found for province ID: ${provinceId}`);
        return { x: 0, y: 0 }; // デフォルト値
    }
    console.log(`Found center for province ID ${provinceId}: ${JSON.stringify(center)}`);
    return center;
}

// 距離を計算
function calculateDistance(x1, y1, x2, y2) {
    return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
}

function processCpuProduction(cpuResources, productionQueue, factionUnits, factionName) {
    console.log(`=== CPU Production Start for ${factionName} ===`);
    console.log(`Initial Resources: ${cpuResources}`);
    console.log(`Faction Units:`, factionUnits);

    // 自陣営が保有している基地を取得
    const ownedBases = bases.filter(base => getBaseFaction(base) === factionName);
    console.log(`Owned Bases:`, ownedBases);

    if (ownedBases.length === 0) {
        console.log(`No bases owned by ${factionName}.`);
        return cpuResources; // 保有基地がない場合は終了
    }

    // ランダムで1つの基地を選択
    const randomBase = ownedBases[Math.floor(Math.random() * ownedBases.length)];
    console.log(`Selected Base:`, randomBase);

    const provinceId = randomBase.provinceId;
    const unitsInProvince = factionUnits.filter(unit => getRoadId(unit.x, unit.y) === String(provinceId));
    console.log(`Units in Province ${provinceId}:`, unitsInProvince);

    if (unitsInProvince.length === 0) {
        console.log(`No units in province ${provinceId}. Skipping production.`);
        return cpuResources; // 基地にユニットがいない場合はスキップ
    }

    const unitCountryId = unitsInProvince[0].countryId; // 基地にいるユニットの国IDを取得
    const unitStatsForCountry = unitStats[unitCountryId];
    console.log(`Unit Stats for Country ${unitCountryId}:`, unitStatsForCountry);

    if (!unitStatsForCountry) {
        console.log(`No unit stats found for country ID ${unitCountryId}.`);
        return cpuResources;
    }

    // 生産優先度: 戦車 > 歩兵
    const unitTypes = ['tank', 'infantry'];
    for (const unitType of unitTypes) {
        const unitCost = unitStatsForCountry[unitType]?.cost;
        const unitTime = unitStatsForCountry[unitType]?.time;

        console.log(`Attempting to produce ${unitType}: Cost=${unitCost}, Time=${unitTime}, Resources=${cpuResources}`);

        if (unitCost !== undefined && cpuResources >= unitCost) {
            const baseCoord = unitType === 'ship' ? baseCoordinates[randomBase.name + '(艦)'] : baseCoordinates[randomBase.name];
            if (!baseCoord) {
                console.log(`Base coordinates not found for ${randomBase.name}.`);
                continue;
            }

            console.log(`Producing ${unitType} at ${baseCoord.x}, ${baseCoord.y}`);

            productionQueue.push({
                id: unitIdCounter++,
                type: unitType,
                countryId: unitCountryId,
                x: baseCoord.x,
                y: baseCoord.y,
                hp: unitStatsForCountry[unitType].hp,
                def: unitStatsForCountry[unitType].def,
                mov: unitStatsForCountry[unitType].mov,
                currentMov: unitStatsForCountry[unitType].mov,
                remainingTime: unitTime
            });

            cpuResources -= unitCost; // 資源を消費
            console.log(`Produced ${unitType}. Remaining Resources: ${cpuResources}`);
            break; // 1ユニット生産したら終了
        } else {
            console.log(`Not enough resources to produce ${unitType}.`);
        }
    }

    console.log(`=== CPU Production End for ${factionName} ===`);
    return cpuResources; // 残りの資源を返す
}

function processCpuProductionQueue(productionQueue, factionUnits) {
    for (let i = productionQueue.length - 1; i >= 0; i--) {
        const unit = productionQueue[i];
        console.log(`Processing production: Unit ID=${unit.id}, Type=${unit.type}, Remaining Time=${unit.remainingTime}`);
        unit.remainingTime--; // 生産時間を減少

        if (unit.remainingTime <= 0) {
            // 生産完了、ユニットを配置
            console.log(`Production complete: Unit ID=${unit.id}, Type=${unit.type}`);
            factionUnits.push({
                id: unit.id,
                type: unit.type,
                countryId: unit.countryId,
                x: unit.x,
                y: unit.y,
                hp: unit.hp,
                def: unit.def,
                mov: unit.mov,
                currentMov: unit.mov // 初期移動力を設定
            });
            units.push({
                id: unit.id,
                type: unit.type,
                countryId: unit.countryId,
                x: unit.x,
                y: unit.y,
                hp: unit.hp,
                def: unit.def,
                mov: unit.mov,
                currentMov: unit.mov // 初期移動力を設定
            });
            console.log(`Unit placed on map: ID=${unit.id}, Type=${unit.type}, Coordinates=(${unit.x}, ${unit.y})`);
            productionQueue.splice(i, 1); // キューから削除
        }
    }
    drawUnits(); // ユニットを再描画
}

canvas.addEventListener('mousemove', function(event) {
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    highlightProvince(x, y); // プロヴィンスをハイライト
    coordinatesDiv.textContent = `X: ${x}, Y: ${y}`; // 座標を表示

    const provinceId = getRoadId(x, y);
    provinceIdDisplay.textContent = `プロヴィンスID: ${provinceId || '不明'}`; // プロヴィンスIDを表示
});

        canvas.addEventListener('click', function(event) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        const provinceId = getRoadId(x, y);

        if (provinceId) {
        // 隣接するプロヴィンスを取得
        const adjacentProvinces = provinceAdjacencies[provinceId] || [];
        console.log(`Clicked Province ID: ${provinceId}`);
        console.log(`Adjacent Provinces: ${adjacentProvinces.join(', ')}`);
    } else {
        console.log('Clicked outside of any province.');
    }

        // クリックされた位置にあるユニットを検索
        const clickedUnit = units.find(unit => {
        const dx = x - unit.x;
        const dy = y - unit.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        return distance <= 15; // 半径15ピクセル以内をクリックした場合にtrueを返す
    });

        units.forEach(unit => {
        const dx = x - unit.x;
        const dy = y - unit.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
    });

    if (clickedUnit) {
        // ユニットがクリックされた場合
        if (selectedUnit === clickedUnit) {
            // 同じユニットが再度クリックされた場合、選択解除
            selectedUnit = null;
            unitSideMenu.style.display = 'none'; // サイドメニューを非表示
        } else {
            // 異なるユニットがクリックされた場合、選択
            selectedUnit = clickedUnit;
            displayUnitStats(selectedUnit); // ユニットのステータスを表示
        }
    } else if (selectedUnit) {
                // 自分の陣営以外のユニットは移動できない
                const playerFaction = Object.keys(factions).find(faction =>
            factions[faction].includes(selectedCountryId)
        );
        if (!playerFaction || !factions[playerFaction].includes(selectedUnit.countryId)) {
            alert('自分の陣営以外のユニットは移動できません。');
            return;
        }

        if (selectedUnit.currentMov <= 0) {
            alert('このユニットは移動力が不足しています。');
            return;
        }

        const targetProvinceId = getRoadId(x, y);
        const currentProvinceId = getRoadId(selectedUnit.x, selectedUnit.y);

        if (targetProvinceId && currentProvinceId &&
            provinceAdjacencies[currentProvinceId] &&
            provinceAdjacencies[currentProvinceId].includes(targetProvinceId)) {

            // 敵ユニットがいる場合は移動を禁止
            if (isEnemyInProvince(targetProvinceId, selectedUnit)) {
                alert('敵ユニットが存在するため、このプロヴィンスには侵入できません。');
                return;
            }

            const center = getProvinceCenter(x, y);
            selectedUnit.x = center.x;
            selectedUnit.y = center.y;
            selectedUnit.currentMov--; // 移動力を1消費
            selectedUnit = null;
            drawUnits();
        } else {
            alert('移動できません。隣接するプロヴィンスを選択してください。');
        }
            // クリックされた位置のプロヴィンスIDを取得
                const provinceId = getRoadId(x, y);

            // プロヴィンスIDをコンソールに出力
            console.log(`Clicked Province ID: ${provinceId}`);
        }
    });

        canvas.addEventListener('mouseleave', function() {
            clearHighlight(); // マウスがキャンバスから離れたらハイライトをクリア
            coordinatesDiv.textContent = ''; // 座標をクリア
        });

// マップ画像の描画後にプロヴィンス番号を描画
displayImage.onload = function() {
    canvas.width = displayImage.width;
    canvas.height = displayImage.height;
    ctx.drawImage(displayImage, 0, 0);
    placeUnit(unitPosition.x, unitPosition.y);
    displayBases();
};

        // 初期ユニット配置
        placeUnit('22', 'infantry', baseCoordinates['ステーネ'].x, baseCoordinates['ステーネ'].y); // スィジュールタ軍(歩兵)
        placeUnit('01', 'infantry', baseCoordinates['ブラウジア'].x, baseCoordinates['ブラウジア'].y); // スクニューネ軍(歩兵)
        placeUnit('01', 'tank', baseCoordinates['スミウルタ'].x, baseCoordinates['スミウルタ'].y); // スクニューネ軍(戦車)
        placeUnit('41', 'infantry', baseCoordinates['ブムァートネ'].x, baseCoordinates['ブムァートネ'].y); // ユスィネ派ニグラシオ軍(歩兵)
        placeUnit('01', 'infantry', baseCoordinates['ガケ'].x, baseCoordinates['ガケ'].y); // スクニューネ軍(歩兵)
        placeUnit('01', 'tank', baseCoordinates['スツューフテ'].x, baseCoordinates['スツューフテ'].y); // スクニューネ軍(戦車)
        placeUnit('42', 'infantry', baseCoordinates['スカカルテ'].x, baseCoordinates['スカカルテ'].y); // スカカルテ軍(歩兵)
        placeUnit('01', 'tank', baseCoordinates['スプミウスタルテ'].x, baseCoordinates['スプミウスタルテ'].y); // スクニューネ軍(戦車)
        placeUnit('01', 'infantry', baseCoordinates['ルルペ'].x, baseCoordinates['ルルペ'].y); // スクニューネ軍(歩兵)
        placeUnit('01', 'infantry', baseCoordinates['ルイネ'].x, baseCoordinates['ルイネ'].y); // スクニューネ軍(歩兵)
        placeUnit('21', 'infantry', baseCoordinates['スツィーフタルテ'].x, baseCoordinates['スツィーフタルテ'].y); // スングィールタ軍(歩兵)
        placeUnit('21', 'tank', baseCoordinates['シュメケルペ'].x, baseCoordinates['シュメケルペ'].y); // スングィールタ軍(戦車)
        preloadUnitImages(); // ユニット画像を事前に読み込む
        drawUnits(); // 初期ユニットを描画
    </script>
</body>
</html>